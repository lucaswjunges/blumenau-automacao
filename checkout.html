<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9CE2GK9LS5"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-9CE2GK9LS5');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Blumenau Automação</title>
    <meta name="description" content="Finalize sua compra - Blumenau Automação">

    <link rel="icon" type="image/png" href="logo1.png">
    <link rel="apple-touch-icon" href="logo1.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            900: '#1a1a2e',
                            800: '#16213e',
                            700: '#1f2b47',
                            600: '#2a3a5a'
                        },
                        accent: {
                            500: '#195F79',
                            400: '#4a9bb5',
                            300: '#7ab8c9'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        .gradient-text {
            background: linear-gradient(135deg, #7ab8c9 0%, #195F79 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #195F79 0%, #7ab8c9 100%);
        }
        .checkout-gradient {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
    </style>
</head>
<body class="bg-primary-900 text-gray-200 font-sans min-h-screen">

    <!-- Header Simplificado -->
    <header class="bg-primary-900/95 backdrop-blur-sm border-b border-primary-700">
        <div class="max-w-[1200px] mx-auto px-4 sm:px-6">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="logo1.png" alt="Blumenau Automação" class="h-10 w-auto">
                    <span class="text-xl font-bold gradient-text">Blumenau Automação</span>
                </a>
                <div class="flex items-center gap-2 text-sm text-gray-400">
                    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Compra Segura
                </div>
            </div>
        </div>
    </header>

    <main class="py-8">
        <div class="max-w-[1200px] mx-auto px-4 sm:px-6">

            <!-- Breadcrumb -->
            <nav class="text-sm text-gray-400 mb-6">
                <a href="index.html" class="hover:text-white">Home</a>
                <span class="mx-2">/</span>
                <a href="produtos.html" class="hover:text-white">Carrinho</a>
                <span class="mx-2">/</span>
                <span class="text-gray-300">Checkout</span>
            </nav>

            <!-- Carrinho Vazio -->
            <div id="empty-cart" class="hidden text-center py-16">
                <svg class="w-24 h-24 mx-auto text-gray-600 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <h2 class="text-2xl font-bold mb-2">Seu carrinho está vazio</h2>
                <p class="text-gray-400 mb-6">Adicione produtos para continuar</p>
                <a href="produtos.html" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition-opacity inline-block">
                    Ver Produtos
                </a>
            </div>

            <!-- Checkout Form -->
            <div id="checkout-content" class="grid lg:grid-cols-3 gap-8">

                <!-- Formulário (2 colunas) -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- Dados Pessoais -->
                    <div class="bg-primary-800 rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-accent-500 rounded-full flex items-center justify-center text-sm font-bold">1</span>
                            Dados Pessoais
                        </h2>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">Nome Completo *</label>
                                <input type="text" id="customer-name" required
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="Seu nome completo">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">E-mail *</label>
                                <input type="email" id="customer-email" required
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="seu@email.com">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Telefone / WhatsApp *</label>
                                <input type="tel" id="customer-phone" required
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="(47) 98867-7798">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Documento</label>
                                <div class="flex gap-2">
                                    <select id="customer-doc-type"
                                        class="bg-primary-700 border border-primary-600 rounded-lg px-3 py-3 focus:outline-none focus:border-accent-400 transition-colors">
                                        <option value="cpf">CPF</option>
                                        <option value="cnpj">CNPJ</option>
                                    </select>
                                    <input type="text" id="customer-doc"
                                        class="flex-1 bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                        placeholder="000.000.000-00">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Opcional, mas necessário para nota fiscal</p>
                            </div>
                        </div>
                    </div>

                    <!-- Endereço de Entrega -->
                    <div class="bg-primary-800 rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-accent-500 rounded-full flex items-center justify-center text-sm font-bold">2</span>
                            Endereço de Entrega
                        </h2>

                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">CEP</label>
                                <input type="text" id="shipping-zip"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="00000-000">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">Rua</label>
                                <input type="text" id="shipping-street"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="Nome da rua">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Número</label>
                                <input type="text" id="shipping-number"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="123">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Complemento</label>
                                <input type="text" id="shipping-complement"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="Apto, Sala...">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Bairro</label>
                                <input type="text" id="shipping-neighborhood"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="Bairro">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Cidade</label>
                                <input type="text" id="shipping-city"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors"
                                    placeholder="Blumenau">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Estado</label>
                                <select id="shipping-state"
                                    class="w-full bg-primary-700 border border-primary-600 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-400 transition-colors">
                                    <option value="">Selecione</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC" selected>SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>
                        </div>

                        <!-- Opções de Frete -->
                        <div id="shipping-options-container" class="mt-4">
                            <div id="shipping-loading" class="hidden p-4 bg-primary-700 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <svg class="w-5 h-5 animate-spin text-accent-400" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                    <span class="text-sm text-gray-400">Calculando frete...</span>
                                </div>
                            </div>

                            <div id="shipping-options" class="hidden space-y-2">
                                <label class="block text-sm font-medium mb-2">Escolha a forma de envio *</label>
                                <!-- Options populated by JS -->
                            </div>

                            <div id="shipping-placeholder" class="p-4 bg-primary-700 rounded-lg">
                                <p class="text-sm text-gray-400">
                                    <strong class="text-accent-400">Frete:</strong> Digite o CEP para calcular as opções de envio.
                                    <br><span class="text-green-400">Frete grátis para Blumenau e região!</span>
                                </p>
                            </div>

                            <div id="shipping-error" class="hidden p-4 bg-red-900/30 border border-red-500/50 rounded-lg">
                                <p class="text-sm text-red-400">Não foi possível calcular o frete. Tente novamente.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Erros -->
                    <div id="error-container" class="hidden bg-red-900/50 border border-red-500 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-red-400">Erro ao processar pedido</p>
                                <ul id="error-list" class="text-sm text-red-300 mt-1 list-disc list-inside"></ul>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Resumo do Pedido (1 coluna) -->
                <div class="lg:col-span-1">
                    <div class="bg-primary-800 rounded-2xl p-6 sticky top-24">
                        <h2 class="text-xl font-bold mb-4">Resumo do Pedido</h2>

                        <!-- Itens -->
                        <div id="cart-items" class="space-y-4 max-h-64 overflow-y-auto mb-4">
                            <!-- Populated by JS -->
                        </div>

                        <hr class="border-primary-700 my-4">

                        <!-- Totais -->
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Subtotal</span>
                                <span id="subtotal">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Frete</span>
                                <span id="shipping-cost" class="text-accent-400">A calcular</span>
                            </div>
                        </div>

                        <hr class="border-primary-700 my-4">

                        <div class="flex justify-between text-lg font-bold">
                            <span>Total</span>
                            <span id="total" class="text-accent-400">R$ 0,00</span>
                        </div>

                        <!-- Botão Finalizar -->
                        <button id="checkout-btn" onclick="processCheckout()"
                            class="w-full checkout-gradient text-white py-4 px-6 rounded-xl font-bold text-lg mt-6 hover:opacity-90 transition-opacity flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            Finalizar Compra
                        </button>

                        <p class="text-xs text-gray-500 text-center mt-4">
                            Você será redirecionado para o Mercado Pago para finalizar o pagamento de forma segura.
                        </p>

                        <!-- Logos Pagamento -->
                        <div class="flex items-center justify-center gap-6 mt-4 pt-4 border-t border-primary-700">
                            <div class="flex flex-col items-center gap-1 text-gray-400">
                                <svg class="h-6 w-6" viewBox="0 0 512 512" fill="currentColor">
                                    <path d="M242.4 292.5C247.8 287.1 257.1 287.1 262.5 292.5L339.5 369.5C353.7 383.7 372.5 391.6 395.2 404C419.7 404 444.3 395.2 463.5 376L506.5 333C525.7 313.8 534.5 289.2 534.5 264.5C534.5 240 525.7 215.3 506.5 196.1L463.5 153.1C451.7 141.3 437.1 134 421.5 131.9L377.6 133.6C363.5 134.1 349.8 128.7 339.6 118.5L262.5 41.4C257.1 36 247.8 36 242.4 41.4L165.4 118.4C155.2 128.6 141.5 134 127.4 133.5L83.46 131.8C67.96 134 53.3 141.3 41.52 153.1L-1.488 196.1C-20.68 215.3 -29.46 239.9 -29.46 264.5C-29.46 289.1 -20.68 313.8 -1.488 333L41.52 376C60.72 395.2 85.32 404 109.9 404C134.5 404 159.2 395.2 178.4 376L242.4 292.5zM261.1 107.5L305.8 152.2C327.6 173.1 356.6 183.3 385.8 181.6L428.9 179.9C433.5 179.8 437.8 181.4 441.2 184.7L484.2 227.7C493.1 236.6 498.5 248.9 498.5 261.5C498.5 274.1 493.1 286.4 484.2 295.3L441.2 338.3C437.8 341.6 433.5 343.2 428.9 343.1L385.8 341.4C356.6 339.7 327.6 349.9 305.8 370.8L261.1 415.5C257.1 419.5 250.8 419.5 246.9 415.5L202.2 370.8C180.4 349.9 151.4 339.7 122.2 341.4L79.07 343.1C74.47 343.2 70.18 341.6 66.81 338.3L23.81 295.3C14.93 286.4 9.538 274.1 9.538 261.5C9.538 248.9 14.93 236.6 23.81 227.7L66.81 184.7C70.18 181.4 74.47 179.8 79.07 179.9L122.2 181.6C151.4 183.3 180.4 173.1 202.2 152.2L246.9 107.5C250.8 103.5 257.1 103.5 261.1 107.5z"/>
                                </svg>
                                <span class="text-xs">Pix</span>
                            </div>
                            <div class="flex flex-col items-center gap-1 text-gray-400">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                </svg>
                                <span class="text-xs">Cartão</span>
                            </div>
                            <div class="flex flex-col items-center gap-1 text-gray-400">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span class="text-xs">Boleto</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
        <div class="text-center">
            <svg class="w-16 h-16 mx-auto animate-spin text-accent-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Processando seu pedido...</p>
            <p class="text-sm text-gray-400">Aguarde, você será redirecionado</p>
        </div>
    </div>

    <script>
        // Funções de carrinho
        function getCart() {
            return JSON.parse(localStorage.getItem('blumenau_cart') || '[]');
        }

        function saveCart(cart) {
            localStorage.setItem('blumenau_cart', JSON.stringify(cart));
        }

        function formatPrice(price) {
            return `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Máscaras de input
        function maskPhone(value) {
            return value
                .replace(/\D/g, '')
                .replace(/^(\d{2})(\d)/g, '($1) $2')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .slice(0, 15);
        }

        function maskCPF(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2')
                .slice(0, 14);
        }

        function maskCNPJ(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1/$2')
                .replace(/(\d{4})(\d{1,2})$/, '$1-$2')
                .slice(0, 18);
        }

        function maskCEP(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .slice(0, 9);
        }

        // Aplicar máscaras
        document.getElementById('customer-phone').addEventListener('input', (e) => {
            e.target.value = maskPhone(e.target.value);
        });

        document.getElementById('customer-doc').addEventListener('input', (e) => {
            const docType = document.getElementById('customer-doc-type').value;
            e.target.value = docType === 'cpf' ? maskCPF(e.target.value) : maskCNPJ(e.target.value);
        });

        document.getElementById('customer-doc-type').addEventListener('change', (e) => {
            const docInput = document.getElementById('customer-doc');
            docInput.value = '';
            docInput.placeholder = e.target.value === 'cpf' ? '000.000.000-00' : '00.000.000/0000-00';
        });

        document.getElementById('shipping-zip').addEventListener('input', (e) => {
            e.target.value = maskCEP(e.target.value);
        });

        // Estado do frete selecionado
        let selectedShipping = null;
        let shippingOptions = [];

        // Busca CEP via ViaCEP e calcula frete
        document.getElementById('shipping-zip').addEventListener('blur', async (e) => {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            try {
                // Busca endereço via ViaCEP
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (!data.erro) {
                    document.getElementById('shipping-street').value = data.logradouro || '';
                    document.getElementById('shipping-neighborhood').value = data.bairro || '';
                    document.getElementById('shipping-city').value = data.localidade || '';
                    document.getElementById('shipping-state').value = data.uf || '';
                }

                // Calcula frete
                await calculateShipping(cep);

            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        });

        // Calcular frete
        async function calculateShipping(cep) {
            const loadingEl = document.getElementById('shipping-loading');
            const optionsEl = document.getElementById('shipping-options');
            const placeholderEl = document.getElementById('shipping-placeholder');
            const errorEl = document.getElementById('shipping-error');

            // Reset estado
            loadingEl.classList.remove('hidden');
            optionsEl.classList.add('hidden');
            placeholderEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            const cart = getCart();
            const items = cart.map(item => ({ id: item.id, quantity: item.quantity }));

            try {
                const response = await fetch('/api/shipping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cep, items })
                });

                const result = await response.json();

                if (!result.success || !result.options?.length) {
                    throw new Error('Sem opções de frete');
                }

                shippingOptions = result.options;

                // Renderiza opções
                optionsEl.innerHTML = `
                    <label class="block text-sm font-medium mb-2">Escolha a forma de envio *</label>
                    ${result.options.map((opt, idx) => `
                        <label class="flex items-center gap-3 p-3 bg-primary-700 rounded-lg cursor-pointer hover:bg-primary-600 transition-colors border-2 ${idx === 0 ? 'border-accent-500' : 'border-transparent'}" data-shipping-option="${idx}">
                            <input type="radio" name="shipping-option" value="${idx}" ${idx === 0 ? 'checked' : ''} class="w-4 h-4 text-accent-500">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">${opt.service}</span>
                                    ${opt.isFree ? '<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">GRÁTIS</span>' : ''}
                                </div>
                                <span class="text-xs text-gray-400">${opt.daysText} - ${opt.carrier}</span>
                            </div>
                            <span class="font-bold ${opt.isFree ? 'text-green-400' : 'text-accent-400'}">${opt.priceFormatted}</span>
                        </label>
                    `).join('')}
                `;

                // Seleciona primeira opção
                selectedShipping = shippingOptions[0];
                updateTotals();

                // Event listeners para opções
                optionsEl.querySelectorAll('input[name="shipping-option"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.value);
                        selectedShipping = shippingOptions[idx];

                        // Atualiza visual
                        optionsEl.querySelectorAll('[data-shipping-option]').forEach(label => {
                            label.classList.remove('border-accent-500');
                            label.classList.add('border-transparent');
                        });
                        e.target.closest('[data-shipping-option]').classList.remove('border-transparent');
                        e.target.closest('[data-shipping-option]').classList.add('border-accent-500');

                        updateTotals();
                    });
                });

                loadingEl.classList.add('hidden');
                optionsEl.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao calcular frete:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }

        // Atualiza totais com frete
        function updateTotals() {
            const cart = getCart();
            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const shippingCost = selectedShipping?.price || 0;
            const total = subtotal + shippingCost;

            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('shipping-cost').textContent = selectedShipping
                ? (selectedShipping.isFree ? 'Grátis' : formatPrice(shippingCost))
                : 'A calcular';
            document.getElementById('total').textContent = formatPrice(total);
        }

        // Renderizar itens do carrinho
        function renderCart() {
            const cart = getCart();

            if (cart.length === 0) {
                document.getElementById('checkout-content').classList.add('hidden');
                document.getElementById('empty-cart').classList.remove('hidden');
                return;
            }

            const container = document.getElementById('cart-items');
            let subtotal = 0;

            container.innerHTML = cart.map(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                return `
                    <div class="flex gap-3">
                        <img src="${item.image || 'https://via.placeholder.com/60'}"
                             alt="${item.name}"
                             class="w-16 h-16 object-contain bg-primary-700 rounded-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm line-clamp-2">${item.name}</p>
                            <p class="text-xs text-gray-400">Qtd: ${item.quantity}</p>
                            <p class="text-accent-400 font-semibold text-sm">${formatPrice(itemTotal)}</p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            updateTotals();
        }

        // Processar checkout
        async function processCheckout() {
            const btn = document.getElementById('checkout-btn');
            const errorContainer = document.getElementById('error-container');
            const errorList = document.getElementById('error-list');
            const loadingOverlay = document.getElementById('loading-overlay');

            // Esconde erros anteriores
            errorContainer.classList.add('hidden');

            // Coleta dados do formulário
            const docType = document.getElementById('customer-doc-type').value;
            const docValue = document.getElementById('customer-doc').value.replace(/\D/g, '') || null;
            const customer = {
                name: document.getElementById('customer-name').value.trim(),
                email: document.getElementById('customer-email').value.trim(),
                phone: document.getElementById('customer-phone').value.replace(/\D/g, ''),
                cpf: docType === 'cpf' ? docValue : null,
                cnpj: docType === 'cnpj' ? docValue : null
            };

            const shipping = {
                zip_code: document.getElementById('shipping-zip').value.replace(/\D/g, ''),
                street: document.getElementById('shipping-street').value.trim(),
                number: document.getElementById('shipping-number').value.trim(),
                complement: document.getElementById('shipping-complement').value.trim(),
                neighborhood: document.getElementById('shipping-neighborhood').value.trim(),
                city: document.getElementById('shipping-city').value.trim(),
                state: document.getElementById('shipping-state').value,
                // Dados do frete selecionado
                method: selectedShipping?.service || null,
                carrier: selectedShipping?.carrier || null,
                cost: selectedShipping?.price || 0
            };

            const cart = getCart();
            const items = cart.map(item => ({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price
            }));

            // Desabilita botão e mostra loading
            btn.disabled = true;
            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items, customer, shipping })
                });

                const result = await response.json();

                if (!result.success) {
                    throw { errors: result.errors || ['Erro desconhecido'] };
                }

                // Limpa carrinho
                saveCart([]);

                // Redireciona para Mercado Pago
                window.location.href = result.data.init_point;

            } catch (error) {
                console.error('Checkout error:', error);

                loadingOverlay.classList.add('hidden');
                btn.disabled = false;

                // Mostra erros
                const errors = error.errors || [error.message || 'Erro ao processar pedido'];
                errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
                errorContainer.classList.remove('hidden');

                // Scroll para erros
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Init
        renderCart();
    </script>

    <!-- Footer -->
    <footer class="bg-primary-800 border-t border-primary-700 py-6 mt-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6">
            <div class="flex flex-wrap justify-center gap-4 mb-4 text-sm">
                <a href="termos-uso.html" class="text-gray-400 hover:text-accent-400 transition-colors">Termos de Uso</a>
                <span class="text-gray-600">|</span>
                <a href="politica-privacidade.html" class="text-gray-400 hover:text-accent-400 transition-colors">Política de Privacidade</a>
                <span class="text-gray-600">|</span>
                <a href="politica-trocas.html" class="text-gray-400 hover:text-accent-400 transition-colors">Trocas e Devoluções</a>
            </div>
            <div class="flex flex-wrap justify-center gap-3 mb-4">
                <span class="bg-green-900/30 text-green-400 rounded px-2 py-1 text-xs flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    Conexão Segura SSL
                </span>
                <span class="bg-blue-900/30 text-blue-400 rounded px-2 py-1 text-xs flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    Mercado Pago
                </span>
                <span class="bg-accent-500/20 text-accent-400 rounded px-2 py-1 text-xs flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Compra Garantida
                </span>
            </div>
            <div class="text-center text-gray-500 text-xs">
                <p>&copy; 2025 Blumenau Automação</p>
            </div>
        </div>
    </footer>

</body>
</html>
