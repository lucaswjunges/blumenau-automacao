name: Atualizar Produtos

on:
  schedule:
    # Roda diariamente às 6h de Brasília (9h UTC)
    - cron: '0 9 * * *'
  workflow_dispatch: # Permite rodar manualmente

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          pip install requests beautifulsoup4 lxml

      - name: Rodar scraper
        run: |
          cd scripts
          python scraper.py --source all --min-price 100 --workers 8 --delay 0.3
        env:
          PYTHONUNBUFFERED: '1'

      - name: Atualizar sitemap
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime

          BASE_URL = "https://www.blumenauautomacao.com.br"
          today = datetime.now().strftime("%Y-%m-%d")

          with open('products.json', 'r') as f:
              data = json.load(f)

          products = data.get('products', [])
          categories = data.get('categories', [])

          sitemap = '''<?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
                  xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">
            <url>
              <loc>{base}/</loc>
              <lastmod>{today}</lastmod>
              <changefreq>daily</changefreq>
              <priority>1.0</priority>
            </url>
            <url>
              <loc>{base}/produtos.html</loc>
              <lastmod>{today}</lastmod>
              <changefreq>daily</changefreq>
              <priority>0.95</priority>
            </url>
            <url>
              <loc>{base}/tecnologias.html</loc>
              <lastmod>{today}</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.85</priority>
            </url>
            <url>
              <loc>{base}/know-how.html</loc>
              <lastmod>{today}</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.80</priority>
            </url>
          '''.format(base=BASE_URL, today=today)

          # Top 50 categorias
          top_cats = sorted(categories, key=lambda x: x['count'], reverse=True)[:50]
          for cat in top_cats:
              sitemap += f'''
            <url>
              <loc>{BASE_URL}/produtos.html?category={cat['id']}</loc>
              <lastmod>{today}</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.75</priority>
            </url>'''

          # Artigos
          artigos = [
              'agentes-ia-automacao', 'digitalizacao-industrial', 'esp32-monitoramento',
              'manutencao-preditiva', 'modernizacao-sistemas-legados', 'n8n-automatizar-tarefas',
              'oee-eficiencia-producao'
          ]
          for art in artigos:
              sitemap += f'''
            <url>
              <loc>{BASE_URL}/artigos/{art}.html</loc>
              <lastmod>{today}</lastmod>
              <changefreq>monthly</changefreq>
              <priority>0.70</priority>
            </url>'''

          # Paginas institucionais
          for page in ['politica-privacidade', 'termos-uso', 'politica-trocas']:
              sitemap += f'''
            <url>
              <loc>{BASE_URL}/{page}.html</loc>
              <lastmod>{today}</lastmod>
              <changefreq>yearly</changefreq>
              <priority>0.30</priority>
            </url>'''

          # Produtos ordenados por preco
          products_sorted = sorted(products, key=lambda x: x.get('price', 0) or 0, reverse=True)
          for i, p in enumerate(products_sorted):
              priority = 0.65 if i < 100 else (0.60 if i < 600 else 0.55)
              image_tag = ""
              if p.get('image'):
                  img = p['image'].replace('&', '&amp;')
                  name = (p.get('name', '') or '')[:100].replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')
                  image_tag = f'''
              <image:image>
                <image:loc>{img}</image:loc>
                <image:title>{name}</image:title>
              </image:image>'''
              sitemap += f'''
            <url>
              <loc>{BASE_URL}/produto.html?id={p['id']}</loc>
              <lastmod>{today}</lastmod>
              <changefreq>weekly</changefreq>
              <priority>{priority}</priority>{image_tag}
            </url>'''

          sitemap += '''
          </urlset>'''

          with open('sitemap.xml', 'w') as f:
              f.write(sitemap)
          print(f"Sitemap atualizado: {len(products)} produtos")
          EOF

      - name: Commit produtos atualizados
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add products.json sitemap.xml
          git diff --staged --quiet || git commit -m "chore: atualiza produtos $(date +'%Y-%m-%d')"
          git push

      - name: Sincronizar com Mercado Livre
        if: ${{ vars.ML_SYNC_ENABLED == 'true' }}
        env:
          ML_ACCESS_TOKEN: ${{ secrets.ML_ACCESS_TOKEN }}
          ML_REFRESH_TOKEN: ${{ secrets.ML_REFRESH_TOKEN }}
          ML_APP_ID: ${{ secrets.ML_APP_ID }}
          ML_SECRET_KEY: ${{ secrets.ML_SECRET_KEY }}
          ML_USER_ID: ${{ secrets.ML_USER_ID }}
        run: |
          python scripts/ml_sync.py
        continue-on-error: true

      - name: Commit mapeamento ML
        if: ${{ vars.ML_SYNC_ENABLED == 'true' }}
        run: |
          git add ml_products_map.json
          git diff --staged --quiet || git commit -m "chore: atualiza preços ML $(date +'%Y-%m-%d')"
          git push
        continue-on-error: true
